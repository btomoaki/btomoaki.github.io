<!doctype html>

<html>

<head>
  <meta charset="utf-8">
  <title>tracking.js - feature detection</title>
  <link rel="stylesheet" href="./assets/demo.css">

  <script src="./build/tracking-min.js"></script>
  <script src="/tracking.js/assets/stats.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.1/dat.gui.min.js"></script>


  <style>
    .demo-container {
      background: #131112;
    }

    #image1 {
      position: absolute;
      left: -1000px;
      top: -1000px;
    }

    #canvas {
      position: absolute;
      left: 50%;
      top: 50%;
      margin: -200px 0 0 -200px;
    }

  </style>
</head>

<body>
  <div class="demo-title">
    <p><a href="http://trackingjs.com" target="_parent">tracking.js</a> Ôºç detect feature points on a image</p>
  </div>

  <div class="demo-frame">
    <div class="demo-container">
      <img id="image1" src="assets/KMB.png" />
      <canvas id="canvas" width="950" height="750"></canvas>
      <video id="video" width="800" height="600" preload autoplay loop muted controls></video>

    </div>
  </div>

  <script>
    (function() {
      // logoTracker ======================================================
      var logoTracker = function() {
        logoTracker.base(this, 'constructor');
      };
      tracking.inherits(logoTracker, tracking.Tracker);

      logoTracker.prototype.templateDescriptors_ = null;
      logoTracker.prototype.templateKeypoints_ = null;
      logoTracker.prototype.fastThreshold = 60;
      logoTracker.prototype.blur = 3;

      logoTracker.prototype.setTemplate = function(pixels, width, height) {
        var blur = tracking.Image.blur(pixels, width, height, 3);
        var grayscale = tracking.Image.grayscale(pixels, width, height);
        this.templateKeypoints_ = tracking.Fast.findCorners(grayscale, width, height);
        this.templateDescriptors_ = tracking.Brief.getDescriptors(grayscale, width, this.templateKeypoints_);
      };

      logoTracker.prototype.track = function(pixels, width, height) {
        var blur = tracking.Image.blur(pixels, width, height, this.blur);
        var grayscale = tracking.Image.grayscale(pixels, width, height);
        var keypoints = tracking.Fast.findCorners(grayscale, width, height, this.fastThreshold);
        var descriptors = tracking.Brief.getDescriptors(grayscale, width, keypoints);
        this.emit('track', {
          data: tracking.Brief.reciprocalMatch(this.templateKeypoints_, this.templateDescriptors_, keypoints, descriptors)
        });
      };

      // Track ===================================================================
      var boxLeft = 800;
      var video = document.getElementById('video');
      var canvas = document.getElementById('canvas');
      var image1 = document.getElementById('image1');
      var canvasRect = canvas.getBoundingClientRect();
      var context = canvas.getContext('2d');
      var templateImageData;
      var capturing = false;
      var videoHeight = 600;
      var videoWidth = 800;

      var tracker = new logoTracker();

      tracker.on('track', function(event) {
        stats.end();

        if (capturing) {
          return;
        }
        // Sorts best matches by confidence.
        event.data.sort(function(a, b) {
          return b.confidence - a.confidence;
        });
        // Re-draws template on canvas.
        context.putImageData(templateImageData, boxLeft, 0);

        // Plots lines connecting matches.
        for (var i = 0; i < Math.min(10, event.data.length); i++) {
          var template = event.data[i].keypoint1;
          var frame = event.data[i].keypoint2;
          if (event.data[i].confidence > 0.9) {
            context.beginPath();
            context.strokeStyle = 'magenta';
            context.moveTo(frame[0], frame[1]);
            context.lineTo(boxLeft + template[0], template[1]);
            context.stroke();
          }
        }
      });

      var trackerTask = tracking.track(video, tracker, {
        camera: true
      });
      // Waits for the user to accept the camera.
      trackerTask.stop();

      // Sync video ============================================================
      function requestFrame() {
        window.requestAnimationFrame(function() {
          context.clearRect(0, 0, canvas.width, canvas.height);
          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            try {
              context.drawImage(video, 0, 0, videoWidth, videoHeight);
            } catch (err) {}
          }
          requestFrame();
        });
      }
      requestFrame();

      context.drawImage(image1, 800, 0, 200, 200);
      templateImageData = context.getImageData(800, 0, 200, 200);
      tracker.setTemplate(templateImageData.data, 200, 200);
      trackerTask.run();

      // GUI Controllers
      var gui = new dat.GUI();
      gui.add(tracker, 'fastThreshold', 20, 100).step(5);
      gui.add(tracker, 'blur', 1.1, 5.0).step(0.1);
    }());

  </script>
</body>

</html>
